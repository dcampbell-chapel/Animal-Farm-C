<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Character & Context Synthesis ‚Äî The Humans (Animal Farm)</title>
<style>
  :root{
    --bg:#fcfbf7;
    --ink:#222;
    --ink-soft:#333;
    --accent:#5b7cfa;
    --accent-2:#ff8a5b;
    --good:#1aa36f;
    --warn:#c6781b;
    --bad:#d34848;
    --card:#fffef8;
    --shadow: 0 2px 10px rgba(0,0,0,.07);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0f1115;
      --ink:#eae9e6;
      --ink-soft:#d5d3cd;
      --accent:#8ea2ff;
      --accent-2:#ffb38f;
      --good:#41d399;
      --warn:#ffb35b;
      --bad:#ff6d6d;
      --card:#141820;
      --shadow: 0 2px 14px rgba(0,0,0,.35);
    }
  }
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.45 "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    background:var(--bg);
    color:var(--ink);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Hand-drawn vibe */
  .scribble-border{
    border:2px solid var(--ink);
    border-radius:18px;
    box-shadow:
      0 0 0 2px var(--bg) inset,
      3px 3px 0 0 rgba(0,0,0,.15);
    position:relative;
  }
  .scribble-border:after{
    content:"";
    position:absolute; inset:-6px;
    border:2px dashed rgba(0,0,0,.15);
    border-radius:24px;
    pointer-events:none;
    filter: url(#wiggle);
  }
  .sketch{
    background:var(--card);
    filter: url(#paper);
  }
  .wavy-underline{
    text-decoration:none;
    background:
      linear-gradient(transparent 65%, rgba(255,223,0,.6) 0) no-repeat;
  }

  /* Layout */
  .wrap{
    display:grid;
    grid-template-columns: 280px 1fr;
    gap:24px;
    max-width:1200px; margin:24px auto; padding:0 16px;
  }
  @media (max-width: 900px){
    .wrap{grid-template-columns: 1fr}
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    gap:16px; margin:16px auto 0; max-width:1200px; padding:0 16px;
  }
  .title{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  }
  .title h1{
    margin:0; font-size: clamp(1.4rem, 2.5vw, 2rem);
  }
  .tag{
    font-size:.85rem; padding:.25rem .55rem; border-radius:999px;
    border:1.5px solid var(--ink);
    background:var(--card);
  }
  .controls{
    display:flex; gap:8px; align-items:center;
  }
  button, .chip{
    cursor:pointer; border:2px solid var(--ink); background:var(--card); color:var(--ink);
    padding:.55rem .8rem; border-radius:12px; font-weight:600;
    box-shadow: var(--shadow);
  }
  button:hover{transform:translateY(-1px)}
  .nav{
    position:sticky; top:12px;
    display:flex; flex-direction:column; gap:12px;
  }
  .step{
    display:grid; grid-template-columns: 36px 1fr; gap:10px; align-items:center;
    padding:10px; border-radius:14px; border:2px solid var(--ink);
    background:var(--card);
    transition:transform .06s ease;
  }
  .step.active{outline:3px dashed var(--accent); outline-offset:3px; transform:rotate(-.3deg)}
  .step svg{width:28px; height:28px}
  .step small{display:block; color:var(--ink-soft); margin-top:2px}

  main{display:grid; gap:20px}
  section{
    padding:18px; border-radius:18px;
  }
  .card{
    padding:16px; border-radius:16px; background:var(--card); border:2px solid var(--ink);
  }

  /* Flip cards for Characters / Mapping */
  .grid{
    display:grid; grid-template-columns: repeat(12, 1fr); gap:16px;
  }
  .g-6{grid-column: span 6}
  .g-4{grid-column: span 4}
  .g-8{grid-column: span 8}
  .g-12{grid-column: span 12}
  @media (max-width:900px){
    .g-6,.g-4,.g-8{grid-column: span 12}
  }
  .flip{
    perspective:1000px; position:relative; height:260px;
  }
  .flip .inner{
    position:absolute; inset:0; transform-style:preserve-3d; transition:transform .6s ease;
  }
  .flip[aria-pressed="true"] .inner{transform:rotateY(180deg)}
  .face{
    position:absolute; inset:0; backface-visibility:hidden;
    border-radius:16px; border:2px solid var(--ink); padding:14px; background:var(--card);
    display:flex; flex-direction:column; justify-content:center; gap:10px;
  }
  .back{transform:rotateY(180deg)}
  .face h3{margin:.2rem 0}
  .face p{margin:0}

  /* Accordions */
  details{
    border:2px solid var(--ink); border-radius:14px; padding:10px 12px; background:var(--card);
  }
  details summary{
    cursor:pointer; list-style:none; font-weight:700;
  }
  details summary::-webkit-details-marker{display:none}

  /* Hotspots diagram */
  .diagram{
    position:relative; min-height:300px; border-radius:18px; border:2px solid var(--ink);
    background:var(--card);
  }
  .pin{
    position:absolute; transform:translate(-50%,-50%); padding:.25rem .5rem;
    border-radius:10px; border:2px solid var(--ink); background:var(--bg); font-size:.85rem;
    white-space:nowrap; box-shadow: var(--shadow);
  }
  .pin[data-key]:hover{outline:3px dashed var(--accent-2); outline-offset:2px}
  .legend{display:flex; gap:8px; flex-wrap:wrap}
  .legend .chip{font-size:.85rem}

  /* Progress dots */
  .progress{
    display:flex; gap:8px; align-items:center; justify-content:center; margin:8px 0;
  }
  .dot{
    width:12px; height:12px; border-radius:50%; border:2px solid var(--ink);
    background:var(--card);
  }
  .dot.on{background:var(--accent)}

  /* CTA */
  .cta{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
       padding:.1rem .35rem; border:1.5px solid var(--ink); border-radius:6px; background:var(--card); font-size:.9rem}
  .muted{opacity:.7}

  /* Link buttons */
  .pill{
    display:inline-flex; align-items:center; gap:.45rem;
    padding:.5rem .8rem; border:2px solid var(--ink); border-radius:999px; text-decoration:none; color:var(--ink);
    background:var(--card);
  }

  /* Tiny arrows and doodles */
  .arrow{
    display:inline-block; transform: translateY(-1px) rotate(-6deg);
    font-weight:900; margin:0 6px;
  }

  /* Accessibility focus */
  :focus-visible{outline:3px dashed var(--accent); outline-offset:3px}
</style>
</head>
<body>
<!-- SVG filters for paper + wiggle -->
<svg width="0" height="0" aria-hidden="true" focusable="false" style="position:absolute">
  <defs>
    <filter id="paper">
      <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" result="noise" seed="2"/>
      <feColorMatrix type="saturate" values="0"/>
      <feBlend in="SourceGraphic" in2="noise" mode="multiply" result="blend"/>
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.97"/>
      </feComponentTransfer>
    </filter>
    <filter id="wiggle">
      <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="1" result="turb" seed="7"/>
      <feDisplacementMap in="SourceGraphic" in2="turb" scale="1.5" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
    <!-- Reusable icons -->
    <symbol id="ico-hat" viewBox="0 0 24 24">
      <path d="M3 14c4-2 14-2 18 0l-1 2c-4-2-12-2-16 0l-1-2Z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M6 12c3-2 9-2 12 0" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M12 9c2 0 3-1 3-2s-1-2-3-2-3 1-3 2 1 2 3 2Z" fill="currentColor"/>
    </symbol>
    <symbol id="ico-bottle" viewBox="0 0 24 24">
      <path d="M9 4h6v3l1 2v11a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2V9l1-2V4Z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M12 4v-2" stroke="currentColor" stroke-width="2" />
    </symbol>
    <symbol id="ico-crown" viewBox="0 0 24 24">
      <path d="M3 17l2-9 5 4 2-6 3 6 6-5 0 10H3Z" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="ico-handshake" viewBox="0 0 24 24">
      <path d="M4 13l4-4 4 4-2 2 2 2 2-2 2 2 4-4" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M8 9l-3-3M19 9l3-3" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="ico-book" viewBox="0 0 24 24">
      <path d="M4 5a3 3 0 0 1 3-3h11v18H7a3 3 0 0 0-3 3V5Z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M8 4h9" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="ico-globe" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M3 12h18M12 3a16 16 0 0 1 0 18M12 3a16 16 0 0 0 0 18" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="ico-arrow" viewBox="0 0 24 24">
      <path d="M3 12h14" stroke="currentColor" stroke-width="2" fill="none"/>
      <path d="M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" fill="none"/>
    </symbol>
  </defs>
</svg>

<header>
  <div class="title">
    <svg width="42" height="42" viewBox="0 0 24 24" aria-hidden="true"><use href="#ico-book"/></svg>
    <h1><span class="wavy-underline">Character & Context Synthesis</span> ‚Äî <em>The Humans</em></h1>
    <span class="tag">Animal Farm</span>
    <span class="tag">Sketchnote Edition</span>
  </div>
  <div class="controls">
    <button id="darkToggle" aria-pressed="false" title="Toggle dark mode">üåó Theme</button>
    <a class="pill" href="#how-to-read">How to read <span class="arrow">‚û∂</span></a>
  </div>
</header>

<div class="wrap">
  <!-- Left nav -->
  <nav class="nav">
    <a class="step active" href="#step-1" data-step="1" aria-current="step">
      <svg><use href="#ico-hat"/></svg>
      <div><strong>1) Literary Data</strong><small>Traits & quotes</small></div>
    </a>
    <a class="step" href="#step-2" data-step="2">
      <svg><use href="#ico-globe"/></svg>
      <div><strong>2) Historical Context</strong><small>1917 & beyond</small></div>
    </a>
    <a class="step" href="#step-3" data-step="3">
      <svg><use href="#ico-arrow"/></svg>
      <div><strong>3) Allegory Map</strong><small>Who = Who</small></div>
    </a>
    <a class="step" href="#step-4" data-step="4">
      <svg><use href="#ico-handshake"/></svg>
      <div><strong>4) External Pressures</strong><small>Pacts & threats</small></div>
    </a>
    <a class="step" href="#step-5" data-step="5">
      <svg><use href="#ico-crown"/></svg>
      <div><strong>5) Synthesis</strong><small>So what?</small></div>
    </a>

    <div class="card sketch scribble-border" id="how-to-read" style="margin-top:8px">
      <strong>How to use this page</strong>
      <ul>
        <li><span class="kbd">Click</span> cards to flip for details.</li>
        <li><span class="kbd">Open</span> accordions for quotes.</li>
        <li><span class="kbd">Tap</span> diagram pins to highlight links.</li>
        <li><span class="kbd">N</span>/<span class="kbd">P</span> for Next/Prev section.</li>
      </ul>
    </div>
  </nav>

  <!-- Main content -->
  <main>
    <!-- Step 1 -->
    <section id="step-1" class="sketch scribble-border">
      <div class="progress" aria-label="progress">
        <span class="dot on"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
      <h2>1) Literary Data <span class="arrow">‚ûú</span> <em>The Humans</em></h2>
      <div class="grid">
        <div class="g-4">
          <div class="flip" role="button" tabindex="0" aria-pressed="false" aria-label="Flip Farmer Jones card" data-flip>
            <div class="inner">
              <div class="face">
                <h3><svg width="22" height="22"><use href="#ico-hat"/></svg> Farmer Jones</h3>
                <p><strong>Key Traits:</strong> Drunk, Incompetent, Neglectful, Exploitative.</p>
                <details>
                  <summary>Key Action/Quote</summary>
                  <p>‚ÄúToo drunk to remember to shut the pop-holes‚Äù (Ch. 1) ‚Äî triggers the animals‚Äô final, successful rebellion.</p>
                </details>
                <p class="muted">Click to flip <span aria-hidden="true">‚Ü∫</span></p>
              </div>
              <div class="face back">
                <p><strong>Symbolic function:</strong> Embodies the decayed <em>old regime</em> ‚Äî power without care, order without provision.</p>
                <p><strong>Mechanism of collapse:</strong> Not a master plan by animals, but the regime‚Äôs <em>own neglect</em> (no food).</p>
                <p class="muted">Click to flip back</p>
              </div>
            </div>
          </div>
        </div>
        <div class="g-4">
          <div class="flip" role="button" tabindex="0" aria-pressed="false" aria-label="Flip Mr. Pilkington card" data-flip>
            <div class="inner">
              <div class="face">
                <h3>Mr. Pilkington (Foxwood)</h3>
                <p><strong>Role:</strong> External landowner, skeptical neighbor.</p>
                <p><strong>Allegory:</strong> Western <em>Britain</em>‚Äîcapitalist power.</p>
                <p class="muted">Click to flip</p>
              </div>
              <div class="face back">
                <p>Represents <em>ongoing pressure</em> from the capitalist world: skepticism, opportunism, and later deals with the pigs.</p>
                <p class="muted">Click to flip back</p>
              </div>
            </div>
          </div>
        </div>
        <div class="g-4">
          <div class="flip" role="button" tabindex="0" aria-pressed="false" aria-label="Flip Mr. Frederick card" data-flip>
            <div class="inner">
              <div class="face">
                <h3>Mr. Frederick (Pinchfield)</h3>
                <p><strong>Role:</strong> Hard, aggressive neighbor.</p>
                <p><strong>Allegory:</strong> <em>Germany</em>‚Äîhostile, tactical.</p>
                <p class="muted">Click to flip</p>
              </div>
              <div class="face back">
                <p>Signals <em>deals & deceit</em> (e.g., forged banknotes), foreshadowing fragile pacts and betrayal.</p>
                <p class="muted">Click to flip back</p>
              </div>
            </div>
          </div>
        </div>
        <div class="g-12">
          <details class="card">
            <summary><strong>Narrator / Old Major Commentary</strong> (open)</summary>
            <p><em>‚ÄúMan is the only creature that consumes without producing.‚Äù</em> ‚Äî establishes the ideological opponent the animals unite against.</p>
          </details>
        </div>
      </div>
    </section>

    <!-- Step 2 -->
    <section id="step-2" class="sketch scribble-border">
      <div class="progress"><span class="dot on"></span><span class="dot on"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
      <h2>2) Historical Context <span class="arrow">‚ûú</span> 1917 & the End of the Tsarist Regime</h2>

      <div class="grid">
        <div class="g-6">
          <div class="card">
            <h3><svg width="20" height="20"><use href="#ico-crown"/></svg> Historical Parallel</h3>
            <ul>
              <li><strong>Farmer Jones</strong> <span class="arrow">‚Üí</span> <strong>Tsar Nicholas II</strong> & Tsarist aristocracy.</li>
              <li><strong>Pilkington</strong> <span class="arrow">‚Üí</span> Britain (capitalist West).</li>
              <li><strong>Frederick</strong> <span class="arrow">‚Üí</span> Germany (hostile power).</li>
            </ul>
            <p class="muted">Nickname: ‚Äú<em>Bloody Nicholas</em>‚Äù underscores repression & indifference.</p>
          </div>
        </div>
        <div class="g-6">
          <div class="card">
            <h3>Key Concepts</h3>
            <ul>
              <li><strong>1917 Revolution:</strong> Collapse of monarchy; abdication of Nicholas II.</li>
              <li><strong>External Hostility:</strong> Western suspicion of the Soviet experiment.</li>
              <li><strong>Shifting Deals:</strong> Tactical cooperation despite ideological enmity.</li>
            </ul>
          </div>
        </div>
        <div class="g-12">
          <details class="card">
            <summary><strong>Click to connect dots</strong> ‚Äî Why Jones‚Äôs negligence matters historically</summary>
            <p>The rebellion is sparked by a <em>basic failure to feed</em> the animals. Allegorically, this mirrors the regime‚Äôs incapacity to meet essential needs‚Äîamplifying public unrest and making the fall inexorable.</p>
          </details>
        </div>
      </div>
    </section>

    <!-- Step 3 -->
    <section id="step-3" class="sketch scribble-border">
      <div class="progress"><span class="dot on"></span><span class="dot on"></span><span class="dot on"></span><span class="dot"></span><span class="dot"></span></div>
      <h2>3) Allegory Map <span class="arrow">‚ûú</span> Tap pins to highlight relationships</h2>

      <div class="diagram" id="map" aria-label="Interactive allegory map">
        <!-- Animals side -->
        <div class="pin" data-key="jones" style="left:14%;top:38%"><svg width="16" height="16" style="vertical-align:-2px"><use href="#ico-bottle"/></svg> Jones</div>
        <div class="pin" data-key="pilk" style="left:18%;top:68%">Pilkington</div>
        <div class="pin" data-key="fred" style="left:29%;top:16%">Frederick</div>

        <!-- History side -->
        <div class="pin" data-key="nicholas" style="left:74%;top:40%"><svg width="16" height="16" style="vertical-align:-2px"><use href="#ico-crown"/></svg> Nicholas II</div>
        <div class="pin" data-key="britain" style="left:82%;top:70%">Britain / Capitalist West</div>
        <div class="pin" data-key="germany" style="left:66%;top:18%">Germany</div>

        <!-- SVG arrows -->
        <svg width="100%" height="100%" style="position:absolute; inset:0" aria-hidden="true">
          <!-- default grey lines -->
          <defs>
            <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
              <polygon points="0 0, 8 3, 0 6" fill="currentColor"></polygon>
            </marker>
          </defs>
          <g stroke="currentColor" stroke-width="2" opacity=".25">
            <line id="line-jones-nicholas" x1="16%" y1="40%" x2="76%" y2="42%" marker-end="url(#arrowhead)"/>
            <line id="line-pilk-brit" x1="20%" y1="70%" x2="84%" y2="72%" marker-end="url(#arrowhead)"/>
            <line id="line-fred-ger" x1="31%" y1="18%" x2="68%" y2="20%" marker-end="url(#arrowhead)"/>
          </g>
        </svg>
      </div>
      <div class="legend" style="margin-top:8px">
        <span class="chip">Tap a pin to highlight its mapping</span>
        <span class="chip">Tap background to clear</span>
      </div>
    </section>

    <!-- Step 4 -->
    <section id="step-4" class="sketch scribble-border">
      <div class="progress"><span class="dot on"></span><span class="dot on"></span><span class="dot on"></span><span class="dot on"></span><span class="dot"></span></div>
      <h2>4) External Pressures <span class="arrow">‚ûú</span> Deals, Threats, & Treachery</h2>
      <div class="grid">
        <div class="g-8">
          <div class="card">
            <h3><svg width="18" height="18"><use href="#ico-handshake"/></svg> Fragile Cooperation</h3>
            <p>The farm‚Äôs revolutionary ideals face <strong>constant outside pressure</strong>: suspicion, opportunism, and short-term pacts that erode purity.</p>
            <ul>
              <li>Frederick‚Äôs <em>deceit</em> (e.g., forged notes) <span class="arrow">‚Üí</span> shows the cost of expedient alliances.</li>
              <li>Shifting relations with Pilkington <span class="arrow">‚Üí</span> mirrors the uneasy posture of the capitalist West.</li>
            </ul>
          </div>
        </div>
        <div class="g-4">
          <div class="flip" role="button" tabindex="0" aria-pressed="false" aria-label="Flip Pact card" data-flip>
            <div class="inner">
              <div class="face">
                <h3>Historical Echo</h3>
                <p><strong>Temporary cooperation</strong> between hostile powers for strategic gain.</p>
                <p class="muted">Click to flip</p>
              </div>
              <div class="face back">
                <p>Think of <em>infamous pacts</em> where rivals made time-bound deals despite core hostility‚Äîuseful, but corrosive to ideals.</p>
                <p class="muted">Click to flip back</p>
              </div>
            </div>
          </div>
        </div>
        <div class="g-12">
          <details class="card">
            <summary><strong>Why it matters to the story</strong></summary>
            <p>These pressures justify <em>tactical compromises</em> by the pigs, helping explain how the revolution‚Äôs egalitarian promise is surrendered for survival and power.</p>
          </details>
        </div>
      </div>
    </section>

    <!-- Step 5 -->
    <section id="step-5" class="sketch scribble-border">
      <div class="progress"><span class="dot on"></span><span class="dot on"></span><span class="dot on"></span><span class="dot on"></span><span class="dot on"></span></div>
      <h2>5) Synthesis <span class="arrow">‚ûú</span> What the Humans Do in the Novel‚Äôs Machine</h2>

      <div class="grid">
        <div class="g-6">
          <div class="card">
            <h3>Literary Function</h3>
            <p>The Humans personify the <strong>exploitative status quo</strong>. Jones‚Äôs personal flaws are symbols of a <em>systemic failure</em> that starves its subjects‚Äîso weak that it <strong>falls by neglect</strong>.</p>
          </div>
        </div>
        <div class="g-6">
          <div class="card">
            <h3>Historical Mapping</h3>
            <p>Jones <span class="arrow">‚Üí</span> <strong>Nicholas II</strong>. Chased off the farm <span class="arrow">‚Üí</span> <strong>1917 Revolution</strong>. Pilkington & Frederick <span class="arrow">‚Üí</span> <strong>Britain & Germany</strong> exerting pressure, cutting deals, and shaping outcomes.</p>
          </div>
        </div>
        <div class="g-12">
          <div class="card">
            <h3>So What?</h3>
            <p>By making <em>human failure</em> the spark for revolt and <em>human pressure</em> the acid that corrodes its ideals, Orwell shows how revolutions can be <strong>born from neglect</strong> and later <strong>bent by geopolitics</strong>.</p>
          </div>
        </div>
      </div>

      <div class="cta">
        <div>
          <a class="pill" href="#step-1">Start Over ‚§∫</a>
          <a class="pill" href="#step-3">Jump to Map ‚§≥</a>
        </div>
        <div class="muted">Tip: press <span class="kbd">N</span> / <span class="kbd">P</span> to move between sections.</div>
      </div>
    </section>
  </main>
</div>

<script>
  // Theme toggle (graceful: just toggles a class on body)
  const btn = document.getElementById('darkToggle');
  const applyMode = () => {
    const m = localStorage.getItem('sketchMode') || 'auto';
    document.documentElement.dataset.theme = m;
  };
  btn.addEventListener('click', () => {
    const cur = localStorage.getItem('sketchMode');
    const next = cur === 'dark' ? 'light' : cur === 'light' ? 'dark' : 'dark';
    localStorage.setItem('sketchMode', next);
    // simulate theme by toggling a class ‚Äî browsers will respect prefers-color-scheme too
    document.body.classList.toggle('manual-dark', next === 'dark');
    document.body.classList.toggle('manual-light', next === 'light');
  });

  // Flip cards
  document.querySelectorAll('[data-flip]').forEach(el=>{
    el.addEventListener('click', ()=> el.setAttribute('aria-pressed', el.getAttribute('aria-pressed')!=='true'));
    el.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); el.click(); }});
  });

  // Progress & nav highlighting on scroll
  const steps = [...document.querySelectorAll('.step')];
  const sections = [...document.querySelectorAll('main section')];
  const dotsBySection = s => s.querySelectorAll('.dot');
  const io = new IntersectionObserver(entries=>{
    entries.forEach(ent=>{
      if(ent.isIntersecting){
        const id = ent.target.id;
        steps.forEach(s=> s.classList.toggle('active', s.getAttribute('href')==='#'+id));
        // turn on dots up to this section
        const idx = sections.indexOf(ent.target);
        sections.forEach((sec,i)=>{
          const dots = dotsBySection(sec);
          dots.forEach((d,j) => d.classList.toggle('on', j<=i));
        });
      }
    });
  }, {threshold:.5});
  sections.forEach(s=> io.observe(s));

  // N / P keyboard navigation
  addEventListener('keydown', (e)=>{
    if (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
    const idx = sections.findIndex(s=> {
      const r = s.getBoundingClientRect();
      return r.top<window.innerHeight/2 && r.bottom>window.innerHeight/2;
    });
    if(e.key.toLowerCase()==='n'){
      const next = sections[Math.min(idx+1, sections.length-1)];
      next?.scrollIntoView({behavior:'smooth', block:'start'});
    } else if(e.key.toLowerCase()==='p'){
      const prev = sections[Math.max(idx-1, 0)];
      prev?.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });

  // Allegory map interactions
  const map = document.getElementById('map');
  const lines = {
    jones: document.getElementById('line-jones-nicholas'),
    nicholas: document.getElementById('line-jones-nicholas'),
    pilk: document.getElementById('line-pilk-brit'),
    britain: document.getElementById('line-pilk-brit'),
    fred: document.getElementById('line-fred-ger'),
    germany: document.getElementById('line-fred-ger')
  };
  let clearTimer;
  const clearAll = () => {
    map.querySelectorAll('.pin').forEach(p=>p.style.outline='none');
    map.querySelectorAll('line').forEach(l=>{ l.style.opacity=.25; l.style.stroke = 'currentColor'; });
  };
  const highlight = (key) => {
    clearTimeout(clearTimer);
    clearAll();
    const pin = map.querySelector(`.pin[data-key="${key}"]`);
    if(pin){
      pin.style.outline='4px dashed var(--accent)';
      const line = lines[key];
      if(line){
        line.style.opacity=1;
        line.style.stroke='var(--accent)';
      }
    }
    clearTimer = setTimeout(()=>{}, 0);
  };
  map.addEventListener('click', (e)=>{
    const pin = e.target.closest('.pin');
    if(!pin){ clearAll(); return; }
    const key = pin.dataset.key;
    highlight(key);
  });

  // Anchor clicks update nav
  steps.forEach(s=>{
    s.addEventListener('click', ()=>{
      steps.forEach(x=>x.classList.remove('active'));
      s.classList.add('active');
    });
  });

  // Initial theme apply
  applyMode();
</script>
</body>
</html>
